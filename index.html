<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Mini Harcama Uygulaması - Login / Sign up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 520px;
      background: #020617;
      border-radius: 20px;
      padding: 20px 22px 26px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.65);
      border: 1px solid #1f2937;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .user-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      background: #020617;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #1f2937;
      flex-shrink: 0;
    }

    .user-name {
      max-width: 90px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #e5e7eb;
    }

    .logout-btn {
      border: none;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.7rem;
      cursor: pointer;
      background: rgba(248,113,113,0.12);
      color: #fecaca;
      transition: background 0.1s ease, transform 0.08s ease, opacity 0.08s ease;
    }

    .logout-btn:hover {
      background: rgba(248,113,113,0.2);
      opacity: 0.96;
    }

    .logout-btn:active {
      transform: translateY(1px);
      opacity: 0.85;
    }

    label {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 2px;
      display: block;
    }

    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99,102,241,0.35);
    }

    button {
      margin-top: 4px;
      width: 100%;
      padding: 9px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s ease;
      box-shadow: 0 8px 22px rgba(79,70,229,0.45);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(79,70,229,0.6);
      opacity: 0.96;
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(79,70,229,0.4);
      opacity: 0.9;
    }

    .auth-tabs {
      display: flex;
      gap: 6px;
      background: #020617;
      border-radius: 999px;
      padding: 3px;
      border: 1px solid #1f2937;
      margin-top: 8px;
      margin-bottom: 10px;
    }

    .auth-tab {
      flex: 1;
      font-size: 0.78rem;
      padding: 5px 0;
      text-align: center;
      border-radius: 999px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #9ca3af;
      transition: background 0.12s ease, color 0.12s ease;
      box-shadow: none;
      margin-top: 0;
    }

    .auth-tab.active {
      background: #111827;
      color: #e5e7eb;
    }

    .auth-forms {
      margin-top: 2px;
      margin-bottom: 12px;
    }

    .auth-form {
      display: none;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .auth-form.active {
      display: flex;
    }

    .summary-card {
      background: radial-gradient(circle at top left, #4f46e5, #1f2937);
      border-radius: 16px;
      padding: 14px 14px 16px;
      margin-bottom: 16px;
    }

    .summary-label {
      font-size: 0.8rem;
      color: #cbd5f5;
    }

    .summary-amount {
      margin-top: 6px;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .summary-amount span {
      font-size: 1rem;
      margin-left: 4px;
      opacity: 0.8;
    }

    .summary-count {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .budget-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .budget-text {
      display: flex;
      flex-direction: column;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .budget-sub {
      font-size: 0.72rem;
      color: #cbd5f5;
      opacity: 0.9;
    }

    .budget-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 0.72rem;
      font-weight: 600;
      cursor: pointer;
      background: rgba(15,23,42,0.2);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(191,219,254,0.3);
      transition: background 0.08s ease, transform 0.08s ease, box-shadow 0.08s ease;
      white-space: nowrap;
      width: auto;
      margin-top: 0;
    }

    .budget-btn:hover {
      background: rgba(15,23,42,0.35);
      transform: translateY(-0.5px);
      box-shadow: 0 0 0 1px rgba(191,219,254,0.6);
    }

    .budget-btn:active {
      transform: translateY(0);
      opacity: 0.9;
    }

    .budget-bar {
      margin-top: 8px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.6);
      overflow: hidden;
    }

    .budget-bar-inner {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: #22c55e;
      transition: width 0.2s ease, background 0.2s ease;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    .row > div {
      flex: 1;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      margin-top: 6px;
    }

    .list-title {
      font-size: 0.86rem;
      color: #9ca3af;
    }

    .clear-btn {
      border: none;
      background: transparent;
      color: #f97373;
      font-size: 0.7rem;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 999px;
      opacity: 0.8;
      width: auto;
      box-shadow: none;
      margin-top: 0;
    }

    .clear-btn:hover {
      background: rgba(248,113,113,0.1);
      opacity: 1;
      transform: none;
      box-shadow: none;
    }

    ul {
      list-style: none;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-radius: 10px;
      background: #020617;
      border: 1px solid #111827;
      font-size: 0.86rem;
      margin-bottom: 6px;
    }

    .item-left {
      display: flex;
      flex-direction: column;
    }

    .item-desc {
      margin-bottom: 2px;
    }

    .item-date {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .item-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .item-amount {
      font-weight: 600;
      margin-left: 12px;
    }

    .item-delete {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(239,68,68,0.1);
      color: #fecaca;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.1s ease, transform 0.08s ease, opacity 0.08s ease;
      box-shadow: none;
      margin-top: 0;
    }

    .item-delete:hover {
      background: rgba(239,68,68,0.18);
      opacity: 0.95;
      transform: translateY(-0.5px);
      box-shadow: none;
    }

    .item-delete:active {
      transform: translateY(1px);
      opacity: 0.85;
    }

    .empty {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .container {
        padding: 18px 16px 22px;
      }
      .summary-amount {
        font-size: 1.4rem;
      }
      .user-name {
        max-width: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div>
        <div class="title">Mini Harcama Uygulaması</div>
        <div class="subtitle" id="subtitleText">Devam etmek için giriş yap veya kayıt ol.</div>
      </div>
      <div id="userBadge" class="user-badge" style="display:none">
        <span class="user-name" id="userNameLabel"></span>
        <button type="button" class="logout-btn" id="logoutBtn">Çıkış</button>
      </div>
    </div>

    <!-- Auth alanı -->
    <div id="authArea">
      <div class="auth-tabs">
        <button type="button" class="auth-tab active" id="loginTab">Giriş yap</button>
        <button type="button" class="auth-tab" id="signupTab">Kayıt ol</button>
      </div>

      <div class="auth-forms">
        <!-- Login form -->
        <form id="loginForm" class="auth-form active">
          <div>
            <label for="loginUsername">Kullanıcı adı</label>
            <input id="loginUsername" type="text" placeholder="örn: enes" required>
          </div>
          <div>
            <label for="loginPassword">Şifre</label>
            <input id="loginPassword" type="password" placeholder="••••••" required>
          </div>
          <button type="submit">Giriş yap</button>
        </form>

        <!-- Sign up form -->
        <form id="signupForm" class="auth-form">
          <div>
            <label for="signupUsername">Kullanıcı adı</label>
            <input id="signupUsername" type="text" placeholder="örn: enes" required>
          </div>
          <div>
            <label for="signupPassword">Şifre</label>
            <input id="signupPassword" type="password" placeholder="En az 4 karakter" required>
          </div>
          <div>
            <label for="signupPassword2">Şifre (tekrar)</label>
            <input id="signupPassword2" type="password" placeholder="Tekrar şifre" required>
          </div>
          <button type="submit">Kayıt ol</button>
        </form>
      </div>
    </div>

    <!-- Asıl uygulama alanı -->
    <div id="appArea" style="display:none">
      <div class="summary-card">
        <div class="summary-label" id="monthLabel">Bu ayki toplam harcama</div>
        <div class="summary-amount" id="totalDisplay">0<span>₺</span></div>
        <div class="summary-count" id="countDisplay">0 kayıt</div>

        <div class="budget-row">
          <div class="budget-text">
            <div id="budgetLabel">Hedef: Ayarlamadın</div>
            <div id="budgetLeft" class="budget-sub"></div>
          </div>
          <button type="button" class="budget-btn" id="budgetBtn">Bütçe</button>
        </div>

        <div class="budget-bar">
          <div class="budget-bar-inner" id="budgetProgress"></div>
        </div>
      </div>

      <form id="expenseForm">
        <div class="row">
          <div>
            <label for="amountInput">Tutar (₺)</label>
            <input id="amountInput" type="number" step="0.01" min="0" placeholder="Örn: 120.50" required>
          </div>
          <div>
            <label for="descInput">Açıklama</label>
            <input id="descInput" type="text" placeholder="Örn: Kahve, yol parası...">
          </div>
        </div>
        <button type="submit">Harcama ekle</button>
      </form>

      <div class="list-header">
        <div class="list-title">Bu ayki harcamaların</div>
        <button type="button" class="clear-btn" id="clearBtn">Bu ayı sıfırla</button>
      </div>

      <ul id="expenseList"></ul>
      <div class="empty" id="emptyState">Henüz hiç harcama eklenmedi.</div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:4000/api";
    const TOKEN_KEY = "mini-expense-token";
    const USERNAME_KEY = "mini-expense-username";

    const authArea = document.getElementById("authArea");
    const loginTab = document.getElementById("loginTab");
    const signupTab = document.getElementById("signupTab");
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");
    const loginUsername = document.getElementById("loginUsername");
    const loginPassword = document.getElementById("loginPassword");
    const signupUsername = document.getElementById("signupUsername");
    const signupPassword = document.getElementById("signupPassword");
    const signupPassword2 = document.getElementById("signupPassword2");

    const appArea = document.getElementById("appArea");
    const expenseForm = document.getElementById("expenseForm");
    const amountInput = document.getElementById("amountInput");
    const descInput = document.getElementById("descInput");
    const totalDisplay = document.getElementById("totalDisplay");
    const countDisplay = document.getElementById("countDisplay");
    const expenseList = document.getElementById("expenseList");
    const emptyState = document.getElementById("emptyState");
    const clearBtn = document.getElementById("clearBtn");
    const budgetLabel = document.getElementById("budgetLabel");
    const budgetLeft = document.getElementById("budgetLeft");
    const budgetProgress = document.getElementById("budgetProgress");
    const budgetBtn = document.getElementById("budgetBtn");

    const userBadge = document.getElementById("userBadge");
    const userNameLabel = document.getElementById("userNameLabel");
    const logoutBtn = document.getElementById("logoutBtn");
    const subtitleText = document.getElementById("subtitleText");
    const monthLabel = document.getElementById("monthLabel");

    let currentToken = null;
    let currentUserName = null;
    let expenses = [];
    let budget = null;

    function getMonthInfo() {
      const d = new Date();
      const monthsTr = [
        "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran",
        "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"
      ];
      const year = d.getFullYear();
      const monthIndex = d.getMonth();
      return {
        label: monthsTr[monthIndex] + " " + year,
        key: year + "-" + String(monthIndex + 1).padStart(2, "0"),
      };
    }

    function updateMonthLabel() {
      const info = getMonthInfo();
      monthLabel.textContent = info.label + " toplam harcama";
    }

    function formatDate(ts) {
      const d = new Date(ts);
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const hours = String(d.getHours()).padStart(2, "0");
      const mins = String(d.getMinutes()).padStart(2, "0");
      return day + "." + month + " • " + hours + ":" + mins;
    }

    async function apiFetch(path, options = {}) {
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        options.headers || {}
      );

      if (currentToken) {
        headers["Authorization"] = "Bearer " + currentToken;
      }

      const res = await fetch(API_BASE + path, {
        ...options,
        headers,
      });

      let data = null;
      try {
        data = await res.json();
      } catch (e) {}

      if (!res.ok) {
        const msg = data && data.error ? data.error : "Sunucu hatası";
        throw new Error(msg);
      }

      return data;
    }

    function setAuth(token, username) {
      currentToken = token;
      currentUserName = username;
      localStorage.setItem(TOKEN_KEY, token);
      localStorage.setItem(USERNAME_KEY, username);
      updateUIVisibility();
      loadAllDataForCurrentUser().catch((err) => {
        console.error(err);
        alert("Veriler yüklenirken hata: " + err.message);
      });
    }

    function clearAuth() {
      currentToken = null;
      currentUserName = null;
      expenses = [];
      budget = null;
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USERNAME_KEY);
      updateUIVisibility();
      render();
    }

    function updateUIVisibility() {
      updateMonthLabel();
      if (currentToken && currentUserName) {
        authArea.style.display = "none";
        appArea.style.display = "block";
        userBadge.style.display = "flex";
        userNameLabel.textContent = currentUserName;
        subtitleText.textContent = "Bu ayki harcamalarını takip ediyorsun.";
      } else {
        authArea.style.display = "block";
        appArea.style.display = "none";
        userBadge.style.display = "none";
        subtitleText.textContent = "Devam etmek için giriş yap veya kayıt ol.";
      }
    }

    function updateBudgetUI(total) {
      if (!budget || budget <= 0) {
        budgetLabel.textContent = "Hedef: Ayarlamadın";
        budgetLeft.textContent = "";
        budgetProgress.style.width = "0%";
        budgetProgress.style.background = "transparent";
        return;
      }

      budgetLabel.textContent = "Hedef: " + budget.toFixed(0) + "₺";
      const diff = budget - total;

      if (diff >= 0) {
        budgetLeft.textContent = "Kalan: " + diff.toFixed(2) + "₺";
      } else {
        budgetLeft.textContent = "Aştın: " + Math.abs(diff).toFixed(2) + "₺";
      }

      let ratio = total / budget;
      if (ratio < 0) ratio = 0;
      const percent = Math.max(0, Math.min(100, ratio * 100));
      budgetProgress.style.width = percent + "%";
      budgetProgress.style.background = diff >= 0 ? "#22c55e" : "#ef4444";
    }

    function render() {
      const total = expenses.reduce((sum, x) => sum + x.amount, 0);
      totalDisplay.innerHTML = total.toFixed(2) + "<span>₺</span>";
      countDisplay.textContent = expenses.length + " kayıt";

      updateBudgetUI(total);

      expenseList.innerHTML = "";

      if (expenses.length === 0) {
        emptyState.style.display = "block";
        return;
      } else {
        emptyState.style.display = "none";
      }

      expenses.forEach((exp) => {
        const li = document.createElement("li");
        li.className = "item";

        const left = document.createElement("div");
        left.className = "item-left";

        const desc = document.createElement("div");
        desc.className = "item-desc";
        desc.textContent = exp.description || "Harcama";

        const date = document.createElement("div");
        date.className = "item-date";
        date.textContent = formatDate(exp.ts);

        left.appendChild(desc);
        left.appendChild(date);

        const right = document.createElement("div");
        right.className = "item-right";

        const amountDiv = document.createElement("div");
        amountDiv.className = "item-amount";
        amountDiv.textContent = exp.amount.toFixed(2) + "₺";

        const delBtn = document.createElement("button");
        delBtn.className = "item-delete";
        delBtn.textContent = "×";
        delBtn.setAttribute("data-id", String(exp.id));

        right.appendChild(amountDiv);
        right.appendChild(delBtn);

        li.appendChild(left);
        li.appendChild(right);

        expenseList.appendChild(li);
      });
    }

    async function loadAllDataForCurrentUser() {
      if (!currentToken) return;
      const monthKey = getMonthInfo().key;

      const [expData, budgetData] = await Promise.all([
        apiFetch(`/expenses?month_key=${monthKey}`),
        apiFetch(`/budget?month_key=${monthKey}`),
      ]);

      expenses = expData.items || [];
      budget = budgetData.amount;
      render();
    }

    // Auth tab switching
    loginTab.addEventListener("click", () => {
      loginTab.classList.add("active");
      signupTab.classList.remove("active");
      loginForm.classList.add("active");
      signupForm.classList.remove("active");
    });

    signupTab.addEventListener("click", () => {
      signupTab.classList.add("active");
      loginTab.classList.remove("active");
      signupForm.classList.add("active");
      loginForm.classList.remove("active");
    });

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = loginUsername.value.trim();
      const password = loginPassword.value;

      if (!username || !password) {
        alert("Kullanıcı adı ve şifre zorunlu.");
        return;
      }

      try {
        const data = await apiFetch("/auth/login", {
          method: "POST",
          body: JSON.stringify({ username, password }),
        });
        loginPassword.value = "";
        setAuth(data.token, data.user.username);
      } catch (err) {
        alert(err.message);
      }
    });

    // Sign up
    signupForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = signupUsername.value.trim();
      const pw1 = signupPassword.value;
      const pw2 = signupPassword2.value;

      if (!username || !pw1 || !pw2) {
        alert("Tüm alanlar zorunlu.");
        return;
      }
      if (pw1.length < 4) {
        alert("Şifre en az 4 karakter olmalı.");
        return;
      }
      if (pw1 !== pw2) {
        alert("Şifreler uyuşmuyor.");
        return;
      }

      try {
        const data = await apiFetch("/auth/signup", {
          method: "POST",
          body: JSON.stringify({ username, password: pw1 }),
        });
        signupPassword.value = "";
        signupPassword2.value = "";
        setAuth(data.token, data.user.username);
      } catch (err) {
        alert(err.message);
      }
    });

    // Logout
    logoutBtn.addEventListener("click", () => {
      if (!confirm("Çıkış yapmak istiyor musun?")) return;
      clearAuth();
    });

    // Harcama ekle
    expenseForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentToken) {
        alert("Önce giriş yapmalısın.");
        return;
      }

      const amountValue = parseFloat(
        String(amountInput.value).replace(",", ".")
      );
      if (isNaN(amountValue) || amountValue <= 0) {
        alert("Lütfen geçerli bir tutar gir.");
        return;
      }
      const descValue = descInput.value.trim();

      try {
        const item = await apiFetch("/expenses", {
          method: "POST",
          body: JSON.stringify({
            amount: amountValue,
            description: descValue,
          }),
        });
        expenses.unshift(item);
        render();
        amountInput.value = "";
        descInput.value = "";
        amountInput.focus();
      } catch (err) {
        alert(err.message);
      }
    });

    // Tek tek sil
    expenseList.addEventListener("click", async (e) => {
      const target = e.target;
      if (!target.matches(".item-delete")) return;
      if (!currentToken) return;

      const id = Number(target.getAttribute("data-id"));
      if (!id) return;

      if (!confirm("Bu harcamayı silmek istiyor musun?")) return;

      try {
        await apiFetch(`/expenses/${id}`, { method: "DELETE" });
        expenses = expenses.filter((x) => x.id !== id);
        render();
      } catch (err) {
        alert(err.message);
      }
    });

    // Bu ayı sıfırla
    clearBtn.addEventListener("click", async () => {
      if (!currentToken) return;

      const info = getMonthInfo();

      const ok = confirm(
        info.label + " için tüm harcamaları silmek istiyor musun?"
      );
      if (!ok) return;

      try {
        await apiFetch(`/expenses/month/current`, {
          method: "DELETE",
        });

        expenses = [];
        render();
      } catch (err) {
        alert("Bu ayı sıfırlarken hata: " + err.message);
      }
    });

    // Bütçe
    budgetBtn.addEventListener("click", async () => {
      if (!currentToken) {
        alert("Önce giriş yapmalısın.");
        return;
      }
      const current = budget ? budget.toString() : "";
      const input = prompt("Bu ayki hedef bütçeni gir (₺):", current);
      if (input === null) return;

      const value = parseFloat(String(input).replace(",", "."));
      if (isNaN(value) || value <= 0) {
        alert("Lütfen 0'dan büyük bir sayı gir.");
        return;
      }

      try {
        const monthKey = getMonthInfo().key;
        const data = await apiFetch("/budget", {
          method: "POST",
          body: JSON.stringify({ amount: value, month_key: monthKey }),
        });
        budget = data.amount;
        const total = expenses.reduce((sum, x) => sum + x.amount, 0);
        updateBudgetUI(total);
      } catch (err) {
        alert(err.message);
      }
    });

    (function init() {
      updateMonthLabel();
      const savedToken = localStorage.getItem(TOKEN_KEY);
      const savedUser = localStorage.getItem(USERNAME_KEY);
      if (savedToken && savedUser) {
        currentToken = savedToken;
        currentUserName = savedUser;
        updateUIVisibility();
        loadAllDataForCurrentUser().catch((err) => {
          console.error(err);
          clearAuth();
        });
      } else {
        updateUIVisibility();
      }
    })();
  </script>
</body>
</html>
